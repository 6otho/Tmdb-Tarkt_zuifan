/**
 * ==============================================================================
 * Cloudflare Worker è¿½ç•ªåˆ—è¡¨ (KVæ™ºèƒ½ç¼“å­˜ + Reflixä¼ªè£…ç‰ˆ)
 * 
 * éƒ¨ç½²è¯´æ˜ï¼š
 * 1. åœ¨ CF åå° Settings -> Variables -> KV Namespace Bindings ä¸­ï¼š
 *    - Variable name å¡«: KV
 *    - KV Namespace é€‰: ANIME_KV (æˆ–è€…ä½ åˆ›å»ºçš„é‚£ä¸ªåå­—)
 * 2. åœ¨ä¸‹æ–¹é…ç½®åŒºå¡«å…¥ä¸‰ä¸ª Key
 * ==============================================================================
 */

// ============================================
// ğŸ”´ å¿…å¡«ï¼šé…ç½®åŒº (è¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„å¯†é’¥)
// ============================================
const TMDB_TOKEN = "eyJhbGciOiJIUz..."; // ğŸ‘ˆ è¿™é‡Œå¡«ç¬¬ä¸€æ­¥è·å–çš„ TMDB é•¿ Token
const TRAKT_CLIENT_ID = "609ff...";       // ğŸ‘ˆ è¿™é‡Œå¡«ç¬¬äºŒæ­¥è·å–çš„ Client ID
const TRAKT_ACCESS_TOKEN = "95e77..."; // ğŸ‘ˆ è¿™é‡Œå¡«ç¬¬ä¸‰æ­¥è·å–çš„ Access Token

// ğŸ”µ æ™ºèƒ½ç¼“å­˜æ—¶é—´é…ç½® (å•ä½ï¼šç§’)
const TTL_LONG = 3600;  // å…¬å…±æ•°æ®(çƒ­é—¨/æ–°ç•ªè¡¨)ç¼“å­˜ 1å°æ—¶ -> åŠ é€ŸåŠ è½½
const TTL_SHORT = 60;   // ä¸ªäººæ•°æ®(å†å²/æ”¶è—)ç¼“å­˜ 1åˆ†é’Ÿ -> ä¿è¯è§‚çœ‹è®°å½•åŒæ­¥åŠæ—¶

// ğŸ”µ Reflix ä¼ªè£…å¤´ (ä¿æŒ Trakt VIP æ•°æ®æ•ˆæœ)
const REFLIX_HEADERS = {
    'Content-Type': 'application/json',
    'trakt-api-version': '2',
    'trakt-api-key': TRAKT_CLIENT_ID,
    'User-Agent': 'Reflix/2.1.0 (iPad; iOS 16.1; Scale/2.00)',
    'Accept': '*/*'
};
const TRAKT_AUTH_HEADERS = { ...REFLIX_HEADERS, 'Authorization': `Bearer ${TRAKT_ACCESS_TOKEN}` };

// ================= ä¸»é€»è¾‘å…¥å£ =================
export default {
    async fetch(request, env, ctx) {
      const url = new URL(request.url);
  
      // æ£€æŸ¥ KV æ˜¯å¦ç»‘å®šæˆåŠŸ
      if (!env.KV) {
          console.warn("âš ï¸ è­¦å‘Šï¼šæœªæ£€æµ‹åˆ°åä¸º 'KV' çš„ç»‘å®šå˜é‡ã€‚ç¼“å­˜åŠŸèƒ½å°†å¤±æ•ˆï¼Œè¯·æ£€æŸ¥ Cloudflare è®¾ç½®ã€‚");
      }
  
      // API è·¯ç”±åˆ†å‘ (å¥—ç”¨æ™ºèƒ½ç¼“å­˜)
      // 1. ä¸ªäººæ•°æ® -> ä½¿ç”¨çŸ­ç¼“å­˜ (TTL_SHORT)
      if (url.pathname === '/api/user/calendar') return handleSmartCache(env, ctx, 'calendar', TTL_SHORT, handleTraktCalendar);
      if (url.pathname === '/api/user/favs') return handleSmartCache(env, ctx, 'favs', TTL_SHORT, handleUserFavs);
      if (url.pathname === '/api/user/history') return handleSmartCache(env, ctx, 'history', TTL_SHORT, handleTraktHistory);
      if (url.pathname === '/api/user/watchlist') return handleSmartCache(env, ctx, 'watchlist', TTL_SHORT, handleTraktWatchlist);
      
      // 2. å…¬å…±æ•°æ® -> ä½¿ç”¨é•¿ç¼“å­˜ (TTL_LONG)
      if (url.pathname === '/api/list') {
          const tab = url.searchParams.get('tab') || 'schedule';
          // ä¸ºä¸åŒåˆ—è¡¨ç”Ÿæˆä¸åŒçš„ç¼“å­˜ Keyï¼Œä¾‹å¦‚ list_hot, list_schedule
          return handleSmartCache(env, ctx, `list_${tab}`, TTL_LONG, () => handleListRequest(url.searchParams));
      }
      
      // 3. æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ (é¢„ç•™æ¥å£)
      if (url.pathname === '/flush') {
          return new Response("ç¼“å­˜æœºåˆ¶å·²è®¾ä¸ºè‡ªåŠ¨è¿‡æœŸã€‚å¦‚éœ€å¼ºåˆ¶åˆ·æ–°ï¼Œè¯·åœ¨ Cloudflare åå° KV å¤„æ‰‹åŠ¨åˆ é™¤ Keyã€‚", {status: 200});
      }
  
      // é»˜è®¤è¿”å›å‰ç«¯é¡µé¢
      return new Response(htmlContent, { headers: { 'content-type': 'text/html;charset=UTF-8' } });
    },
};

// ================= ğŸ§  æ™ºèƒ½ç¼“å­˜æ ¸å¿ƒå‡½æ•° =================
async function handleSmartCache(env, ctx, key, ttl, fetchFunction) {
    // å¦‚æœæ²¡æœ‰ç»‘å®š KVï¼Œç›´æ¥è¯·æ±‚æºç«™ï¼Œä¸èµ°ç¼“å­˜é€»è¾‘
    if (!env.KV) return fetchFunction();

    // 1. å°è¯•ä» KV è¯»å–ç¼“å­˜
    const cached = await env.KV.get(key);
    if (cached) {
        // å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›ï¼Œå¹¶åŠ ä¸Šæ ‡è®°å¤´ X-Cache: HIT
        return new Response(cached, { 
            headers: { 'Content-Type': 'application/json', 'X-Cache': 'HIT' } 
        });
    }

    // 2. æ²¡æœ‰ç¼“å­˜ï¼Œæ‰§è¡ŒåŸå‡½æ•°å»è¯·æ±‚ Trakt/TMDB
    const response = await fetchFunction();
    
    // 3. åªæœ‰å½“è¯·æ±‚æˆåŠŸ (çŠ¶æ€ç  200) æ—¶æ‰å†™å…¥ç¼“å­˜
    if (response.status === 200) {
        // å¤åˆ¶ä¸€ä»½æ•°æ®ç”¨äºå­˜å‚¨ (å› ä¸º response body åªèƒ½è¯»ä¸€æ¬¡)
        const data = await response.clone().text();
        
        // å¼‚æ­¥å†™å…¥ KVï¼Œä¸é˜»å¡å½“å‰è¯·æ±‚è¿”å›
        ctx.waitUntil(env.KV.put(key, data, { expirationTtl: ttl })); 
    }

    return response;
}

// ================= ğŸ§± åç«¯ä¸šåŠ¡é€»è¾‘ =================

// é€šç”¨å·¥å…·ï¼šTrakt æ•°æ®è½¬ TMDB æ•°æ® (è¡¥å……å›¾ç‰‡ + æ—¶é—´å¤„ç†)
async function hydrateTrakt(items, typeOverride) {
    const promises = items.map(async (item) => {
        let tmdbId, mediaType, airTimeStr;
        
        // æå–æ—¶é—´
        if (item.first_aired) airTimeStr = item.first_aired;

        // æå– ID å’Œ ç±»å‹
        if (item.show) { tmdbId = item.show.ids.tmdb; mediaType = 'tv'; }
        else if (item.movie) { tmdbId = item.movie.ids.tmdb; mediaType = 'movie'; }
        else if (item.type === 'show') { tmdbId = item.show.ids.tmdb; mediaType = 'tv'; }
        else if (item.type === 'movie') { tmdbId = item.movie.ids.tmdb; mediaType = 'movie'; }
        
        if (!tmdbId) return null; // æ²¡æœ‰ TMDB ID æ— æ³•è·å–å›¾ç‰‡ï¼Œè·³è¿‡

        try {
            // è¯·æ±‚ TMDB è·å–ä¸­æ–‡ä¿¡æ¯å’Œå›¾ç‰‡
            const r = await fetch(`https://api.themoviedb.org/3/${mediaType}/${tmdbId}?language=zh-CN`, { 
                headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } 
            });
            const d = await r.json();
            
            // åˆå¹¶æ•°æ®
            return { 
                ...d, 
                media_type: mediaType, 
                trakt_type: typeOverride,
                air_time_iso: airTimeStr, // ä¿ç•™ Trakt çš„å‡†ç¡®æ’­å‡ºæ—¶é—´
                episode_info: item.episode // ä¿ç•™é›†æ•°ä¿¡æ¯
            }; 
        } catch { return null; }
    });
    
    // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆå¹¶è¿‡æ»¤æ— æ•ˆé¡¹
    const results = await Promise.all(promises);
    return results.filter(i => i !== null);
}

// 1. ä¸ªäººè¿½ç•ªå‘¨å† (Trakt)
async function handleTraktCalendar() {
    try {
        const today = new Date().toISOString().split('T')[0];
        // è·å–æœªæ¥ 7 å¤©çš„ä¸ªäººæ—¥å†
        const res = await fetch(`https://api.trakt.tv/calendars/my/shows/${today}/7`, { headers: TRAKT_AUTH_HEADERS });
        const data = await res.json();
        const hydrated = await hydrateTrakt(data, 'calendar');
        return new Response(JSON.stringify(hydrated), { headers: {'Content-Type': 'application/json'} });
    } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500 }); }
}

// 2. æ–°ç•ªæ—¶åˆ» (å…¬å…±æ—¥æ¼«æ—¥å† - Trakt)
async function handlePublicAnimeCalendar() {
    try {
        const today = new Date().toISOString().split('T')[0];
        // è·å– Trakt å…¬å…±æ—¥å† (æœªæ¥3å¤©)ï¼Œå¸¦ extended ä¿¡æ¯ä»¥ä¾¿è¿‡æ»¤
        const res = await fetch(`https://api.trakt.tv/calendars/all/shows/${today}/3?extended=full`, { headers: REFLIX_HEADERS });
        const data = await res.json();
        
        // âš¡ï¸ æ ¸å¿ƒè¿‡æ»¤ï¼šåªä¿ç•™ æ—¥æœ¬(jp) ä¸” ç±»å‹åŒ…å«åŠ¨ç”»(anime) çš„æ¡ç›®
        const animeItems = data.filter(i => {
            const country = i.show?.country || '';
            const genres = i.show?.genres || [];
            return (country === 'jp') && (genres.includes('anime') || genres.includes('animation'));
        });

        const hydrated = await hydrateTrakt(animeItems, 'schedule');
        return new Response(JSON.stringify(hydrated), { headers: {'Content-Type': 'application/json'} });
    } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500 }); }
}

// 3. Trakt å†å²è®°å½•
async function handleTraktHistory() {
    try {
        const res = await fetch('https://api.trakt.tv/sync/history?limit=20', { headers: TRAKT_AUTH_HEADERS });
        const data = await res.json();
        const hydrated = await hydrateTrakt(data, 'history');
        // å»é‡
        const seen = new Set();
        return new Response(JSON.stringify(hydrated.filter(i => { if(seen.has(i.id)) return false; seen.add(i.id); return true; })), { headers: {'Content-Type': 'application/json'} });
    } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500 }); }
}

// 4. Trakt å¾…çœ‹åˆ—è¡¨ (Watchlist)
async function handleTraktWatchlist() {
    try {
        const res = await fetch('https://api.trakt.tv/sync/watchlist?sort=added,asc', { headers: TRAKT_AUTH_HEADERS });
        const data = await res.json();
        const hydrated = await hydrateTrakt(data, 'watchlist');
        return new Response(JSON.stringify(hydrated), { headers: {'Content-Type': 'application/json'} });
    } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500 }); }
}

// 5. TMDB æ”¶è— (Fallback)
async function handleUserFavs() {
  try {
    const accRes = await fetch('https://api.themoviedb.org/3/account', { headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } });
    const accData = await accRes.json();
    const [tvRes, movieRes] = await Promise.all([
      fetch(`https://api.themoviedb.org/3/account/${accData.id}/favorite/tv?language=zh-CN&sort_by=created_at.desc`, { headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } }),
      fetch(`https://api.themoviedb.org/3/account/${accData.id}/favorite/movies?language=zh-CN&sort_by=created_at.desc`, { headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } })
    ]);
    const combined = [
      ...(await tvRes.json()).results.map(i => ({...i, media_type: 'tv'})),
      ...(await movieRes.json()).results.map(i => ({...i, media_type: 'movie'}))
    ];
    return new Response(JSON.stringify(combined), { headers: {'Content-Type': 'application/json'} });
  } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500 }); }
}

// 6. å…¬å…±åˆ—è¡¨è·¯ç”± (çƒ­é—¨/è¶‹åŠ¿)
async function handleListRequest(params) {
  const tab = params.get('tab') || 'schedule';
  const commonQ = { language: 'zh-CN', include_adult: 'false', with_genres: '16', with_original_language: 'ja', without_genres: '10763,10764' };

  try {
    let results = [];
    if (tab === 'schedule') {
        // ğŸ”¥ æ–°ç•ªæ—¶åˆ»
        return handlePublicAnimeCalendar();
    } else if (tab === 'trakt_hot') {
        // ğŸ”¥ Trakt çƒ­é—¨ (Reflixæº)
         const [s, m] = await Promise.all([
            fetch('https://api.trakt.tv/shows/trending?limit=10', { headers: REFLIX_HEADERS }),
            fetch('https://api.trakt.tv/movies/trending?limit=10', { headers: REFLIX_HEADERS })
        ]);
        const combined = [...(await s.json()), ...(await m.json())].sort((a,b)=>b.watchers-a.watchers);
        results = await hydrateTrakt(combined, 'trending');
    } else if (tab === 'hot') {
        // TMDB çƒ­é—¨
        const [movieRes, tvRes] = await Promise.all([
            fetch(`https://api.themoviedb.org/3/discover/movie?${new URLSearchParams({...commonQ, sort_by: 'popularity.desc', 'vote_count.gte': '50', page: '1'})}`, { headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } }),
            fetch(`https://api.themoviedb.org/3/discover/tv?${new URLSearchParams({...commonQ, sort_by: 'popularity.desc', 'vote_count.gte': '50', page: '1'})}`, { headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } })
        ]);
        results = [
            ...(await movieRes.json()).results.map(i => ({...i, media_type: 'movie'})),
            ...(await tvRes.json()).results.map(i => ({...i, media_type: 'tv'}))
        ].sort((a, b) => b.popularity - a.popularity);
    } else {
        // TMDB é«˜åˆ†
        const res = await fetch(`https://api.themoviedb.org/3/discover/tv?${new URLSearchParams({ ...commonQ, sort_by: 'vote_average.desc', 'vote_count.gte': '300', page: '1' })}`, { headers: { 'Authorization': `Bearer ${TMDB_TOKEN}` } });
        results = (await res.json()).results || [];
    }
    const seen = new Set();
    return new Response(JSON.stringify({ results: results.filter(i => { if(seen.has(i.id)) return false; seen.add(i.id); return true; }) }), { headers: { 'Content-Type': 'application/json' }});
  } catch (e) { return new Response(JSON.stringify({ error: e.message }), { status: 500 }); }
}

// ================= ğŸ¨ å‰ç«¯ Vue ä»£ç  (HTMLå­—ç¬¦ä¸²) =================
const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>æˆ‘çš„è¿½ç•ª</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg-body: #000000;
    --bg-gradient: linear-gradient(160deg, #1a1b2e 0%, #0d0d12 100%);
    --glass-bg: rgba(30, 30, 35, 0.4);
    --glass-border: rgba(255, 255, 255, 0.08);
    --glass-highlight: rgba(255, 255, 255, 0.15);
    --glass-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.6);
    --text-main: #ffffff;
    --text-sub: #9ca3af;
    --accent-blue: #4f8aff;
    --nav-bg: rgba(20, 20, 22, 0.75);
    --max-width: 450px;
    --pill-bg: rgba(255, 255, 255, 0.1);
  }
  
  .light-mode {
    --bg-body: #eef1f5;
    --bg-gradient: linear-gradient(160deg, #f0f2f5 0%, #e0e5ec 100%);
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: rgba(255, 255, 255, 0.6);
    --glass-highlight: rgba(255, 255, 255, 0.9);
    --glass-shadow: 0 10px 40px -10px rgba(100, 110, 140, 0.2);
    --text-main: #1d1d1f;
    --text-sub: #6e6e73;
    --accent-blue: #0071e3;
    --nav-bg: rgba(255, 255, 255, 0.7);
    --pill-bg: rgba(255, 255, 255, 0.5);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    display: flex; justify-content: center;
    min-height: 100vh; margin: 0;
    touch-action: pan-y; 
  }

  #app-container {
    width: 100%; max-width: var(--max-width);
    background: var(--bg-gradient);
    min-height: 100vh; position: relative;
    box-shadow: 0 0 50px rgba(0,0,0,0.3);
    padding-bottom: 110px;
    transition: background 0.5s ease;
  }
  .hide-scroll::-webkit-scrollbar { display: none; }

  /* 3D ç»ç’ƒé€šç”¨ç±» */
  .glass-3d {
    background: var(--glass-bg);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border);
    border-top-color: var(--glass-highlight);
    border-left-color: var(--glass-highlight);
    box-shadow: var(--glass-shadow);
  }

  /* èƒ¶å›ŠæŒ‰é’® */
  .pill-btn {
    background: var(--glass-bg); color: var(--text-sub);
    padding: 8px 18px; border-radius: 99px;
    font-size: 13px; font-weight: 600; 
    border: 1px solid var(--glass-border);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    backdrop-filter: blur(10px);
    white-space: nowrap;
  }
  .pill-btn.active {
    background: var(--text-main); color: var(--bg-body);
    border-color: var(--text-main);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transform: scale(1.05);
  }

  /* åª’ä½“å¡ç‰‡ */
  .media-card {
    @apply glass-3d; 
    display: flex; gap: 16px; padding: 14px;
    margin-bottom: 12px; margin-left: 14px; margin-right: 14px;
    border-radius: 24px; cursor: pointer; touch-action: manipulation;
    transition: transform 0.2s, background 0.2s;
  }
  .media-card:active { transform: scale(0.96); background: rgba(100,100,100,0.1); }
  
  .poster-thumb {
    width: 70px; height: 105px; border-radius: 14px;
    object-fit: cover; background: #222; flex-shrink: 0;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  .title-text {
      color: var(--text-main); font-weight: 700; font-size: 16px;
      line-height: 1.3; margin-bottom: 2px;
      display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
  }
  .meta-text {
      font-size: 11px; font-weight: 600; color: var(--text-main); opacity: 0.6;
      margin-bottom: 6px; letter-spacing: 0.3px;
  }
  .overview-text {
      font-size: 12px; line-height: 1.45; color: var(--text-sub); font-weight: 500;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }

  /* åº•éƒ¨èƒ¶å›Šå¯¼èˆª */
  .capsule-nav {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    width: 200px; height: 60px;
    background: var(--nav-bg);
    backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%);
    border: 1px solid var(--glass-border); border-radius: 99px;
    display: flex; justify-content: space-evenly; align-items: center;
    z-index: 50; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.4);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 3px;
    color: var(--text-sub); font-size: 10px; font-weight: 600; width: 60px;
    transition: all 0.3s;
  }
  .nav-item.active { color: var(--text-main); }
  .nav-icon { font-size: 20px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .nav-item.active .nav-icon { transform: translateY(-2px) scale(1.1); }

  .status-pill {
    background: rgba(125,125,125,0.1); border: 1px solid rgba(125,125,125,0.2); 
    border-radius: 12px; padding: 4px 10px; font-size: 10px; font-weight: 700; color: var(--text-main); opacity: 0.8;
  }
  .blue-meta { color: var(--accent-blue); font-family: "SF Pro Rounded", sans-serif; font-size: 13px; font-weight: 800; }
  
  /* æ— é™å¾ªç¯æ»šè½® */
  .hero-roller {
    position: relative; 
    width: 100%; height: 220px; 
    overflow-y: auto; scroll-snap-type: y mandatory; 
    border-radius: 32px; 
    box-shadow: 0 15px 35px -5px rgba(0,0,0,0.4);
    border: 1px solid var(--glass-border);
    scroll-behavior: smooth;
    -ms-overflow-style: none; scrollbar-width: none;
  }
  .hero-roller::-webkit-scrollbar { display: none; }

  .hero-slide {
    width: 100%; height: 100%; 
    scroll-snap-align: start; position: relative;
  }
  .hero-slide img { width: 100%; height: 100%; object-fit: cover; }
  
  .scroll-indicators {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    display: flex; flex-direction: column; gap: 6px; z-index: 20;
    pointer-events: none;
  }
  .indicator-dot { width: 4px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 99px; }

  /* æ˜ŸæœŸæ»‘åŠ¨å®¹å™¨ */
  .swipe-area {
    min-height: 300px;
    touch-action: pan-y;
  }
  
  .fade-slide-enter-active, .fade-slide-leave-active { transition: all 0.25s ease; }
  .fade-slide-enter-from { opacity: 0; transform: translateX(10px); }
  .fade-slide-leave-to { opacity: 0; transform: translateX(-10px); }
  
  .trakt-tag { 
      font-size: 9px; padding: 2px 4px; border-radius: 4px; margin-left: 6px; vertical-align: middle;
  }
</style>
</head>
<body>

<div id="app-container">
    <!-- Header -->
    <header class="sticky top-0 z-40 px-6 py-4 flex items-center justify-between transition-colors z-50">
        <div class="absolute inset-0 bg-[var(--bg-body)]/0 backdrop-blur-[2px]"></div>
        
        <a href="javascript:location.reload()" class="relative active:opacity-60 transition-opacity z-10">
            <img src="https://www.themoviedb.org/assets/2/v4/logos/v2/blue_short-8e7b30f73a4020692ccca9c88bafe5dcb6f8a62a4c6bc55cd9ba82bb2cd95f6c.svg" 
                 alt="TMDB" class="h-3.5 object-contain filter drop-shadow-lg">
        </a>
        
        <div class="flex gap-3 relative z-10">
            <button @click="toggleTheme" class="w-9 h-9 rounded-full glass-3d flex items-center justify-center active:scale-90 transition-transform">
                <i :class="isLight ? 'fas fa-sun text-orange-400' : 'fas fa-moon text-blue-300'"></i>
            </button>
            <button class="w-9 h-9 rounded-full glass-3d flex items-center justify-center active:scale-90 transition-transform">
                <i class="fas fa-user-circle" style="color: var(--text-sub)"></i>
            </button>
        </div>
    </header>

    <main>
        <!-- Banner -->
        <div v-if="filteredList.length > 0 && currentSubTab !== 'fav_all' && currentSubTab !== 'watchlist'" class="px-4 mt-1 relative">
            <div class="hero-roller">
                <div v-for="(item, index) in infiniteBannerList" :key="index" class="hero-slide" @click="openDetail(item)">
                    <img :src="getBackdrop(item.backdrop_path)" loading="lazy">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex flex-col justify-end p-6">
                        <div class="flex items-center gap-2 mb-2">
                             <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                             <span class="text-[11px] text-blue-300 font-bold uppercase tracking-wider">
                                 {{ getStatusLabel() }}
                             </span>
                        </div>
                        <h2 class="text-white font-bold text-xl line-clamp-1 drop-shadow-md">{{ item.name || item.title }}</h2>
                        <p class="text-white/80 text-xs mt-1.5 line-clamp-1 font-medium">{{ item.overview || 'æš‚æ— ç®€ä»‹' }}</p>
                    </div>
                </div>
            </div>
            <!-- åªæœ‰å¤šäº1é¡µæ—¶æ‰æ˜¾ç¤ºæŒ‡ç¤ºå™¨ -->
            <div v-if="infiniteBannerList.length > 1" class="scroll-indicators">
                <div class="indicator-dot bg-white/90"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
            </div>
        </div>

        <!-- Filters -->
        <div class="px-5 flex gap-3 overflow-x-auto hide-scroll mb-6 pb-2 pt-2">
            <button v-for="tab in subTabs" :key="tab.key" 
                @click="currentSubTab = tab.key"
                :class="['pill-btn', currentSubTab === tab.key ? 'active' : '']">
                {{ tab.name }}
            </button>
        </div>

        <!-- Loading -->
        <div v-if="loading" class="py-24 flex justify-center">
            <div class="w-8 h-8 border-4 border-[var(--text-sub)] border-t-transparent rounded-full animate-spin opacity-50"></div>
        </div>

        <!-- List Content Area -->
        <div v-else class="flex flex-col swipe-area" 
             @touchstart="touchStart" 
             @touchend="touchEnd">
             
            <!-- Week Selector -->
            <div v-if="isScheduleTab" 
                 class="flex justify-between mb-5 px-8 select-none transition-all duration-300">
                 <button v-for="(day, idx) in weekDays" :key="idx" @click="selectedDay = idx"
                    class="text-xs font-semibold flex flex-col items-center gap-1.5 transition-all"
                    :style="{ color: selectedDay === idx ? 'var(--accent-blue)' : 'var(--text-sub)', opacity: selectedDay === idx ? 1 : 0.6, transform: selectedDay === idx ? 'scale(1.1)' : 'scale(1)' }">
                    <span>{{ day }}</span>
                    <span class="w-1.5 h-1.5 rounded-full transition-all" 
                          :style="{ background: selectedDay === idx ? 'var(--accent-blue)' : 'transparent'}"></span>
                 </button>
            </div>

            <!-- Cards -->
            <transition-group name="fade-slide" tag="div">
                <div v-for="item in filteredList" :key="item.id" @click="openDetail(item)" class="media-card group">
                    <img :src="getPoster(item.poster_path)" class="poster-thumb">
                    
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <h3 class="title-text">{{ item.name || item.title }}</h3>
                        <div class="meta-text">
                            {{ (item.first_air_date||item.release_date||'').slice(0,4) }} &middot; {{ item.media_type==='movie'?'å‰§åœºç‰ˆ':'TV' }}
                            <span v-if="item.trakt_type === 'history'" class="trakt-tag bg-green-500/20 text-green-500">æ­£åœ¨çœ‹</span>
                            <span v-if="item.trakt_type === 'watchlist'" class="trakt-tag bg-orange-500/20 text-orange-500">å¾…çœ‹</span>
                            <span v-if="item.trakt_type === 'trending'" class="trakt-tag bg-red-500/20 text-red-500">Hot</span>
                        </div>
                        <p class="overview-text">{{ item.overview || 'æš‚æ— ç®€ä»‹' }}</p>
                    </div>
                    
                    <div class="flex flex-col justify-center items-end gap-2 shrink-0 pl-1">
                        <!-- ğŸ”¥ è¿½ç•ªå‘¨å† & æ–°ç•ªæ—¶åˆ»ï¼šæ˜¾ç¤ºé›†æ•° + æ—¶é—´ -->
                        <div v-if="isScheduleTab && item.air_time_iso" class="flex flex-col items-end">
                             <!-- é›†æ•°åœ¨æ—¶é—´ä¸Šæ–¹ -->
                             <div class="blue-meta mb-0.5">{{ getFakeEpisode(item) }}</div>
                             <!-- æ—¶é—´å­—ä½“æ›´å°æ›´æ·¡ -->
                             <div class="text-[10px] font-bold opacity-80" style="color: var(--text-sub); font-family: 'SF Pro Rounded', sans-serif">
                                 {{ formatTime(item.air_time_iso) }}
                             </div>
                        </div>
                        
                        <!-- æ™®é€šæ¨¡å¼ -->
                        <div v-else class="blue-meta">{{ getFakeEpisode(item) }}</div>
                        
                        <div class="status-pill whitespace-nowrap">{{ getStatusText(item) }}</div>
                    </div>
                </div>
            </transition-group>

            <div v-if="filteredList.length === 0" class="py-24 text-center text-sm font-medium select-none" style="color: var(--text-sub)">
                <i class="far fa-folder-open mb-3 text-2xl opacity-50"></i><br>
                <span v-if="isScheduleTab">ä»Šå¤©æ²¡æœ‰æ›´æ–°å“¦</span>
                <span v-else>æš‚æ— å†…å®¹</span>
            </div>
        </div>
    </main>

    <!-- Capsule Nav -->
    <nav class="capsule-nav">
        <button @click="switchMainTab('discover')" :class="['nav-item', currentMainTab === 'discover' ? 'active' : '']">
            <i class="fas fa-compass nav-icon"></i>
            <span>å‘ç°</span>
        </button>
        <button @click="switchMainTab('mine')" :class="['nav-item', currentMainTab === 'mine' ? 'active' : '']">
            <i class="fas fa-user nav-icon"></i>
            <span>æˆ‘çš„</span>
        </button>
    </nav>

    <!-- Modal -->
    <div v-if="selected" class="fixed inset-0 z-50 flex items-center justify-center p-5">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-md transition-opacity" @click="selected = null"></div>
        <div class="relative w-full max-w-[380px] bg-[var(--bg-body)] rounded-[32px] overflow-hidden h-[72vh] flex flex-col animate-pop shadow-2xl border border-[var(--glass-border)]">
            <div class="h-64 relative shrink-0">
                <img :src="getBackdrop(selected.backdrop_path)" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg-body)] to-transparent"></div>
                <button @click="selected = null" class="absolute top-5 right-5 w-9 h-9 rounded-full glass-3d flex items-center justify-center text-white active:scale-90 transition-transform z-20">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="px-7 py-2 overflow-y-auto flex-1 -mt-6 relative z-10">
                <h2 class="text-2xl font-bold mb-3 leading-tight" style="color: var(--text-main)">{{ selected.name || selected.title }}</h2>
                <div class="flex flex-wrap gap-2 mb-6">
                     <span class="text-[10px] font-bold px-2.5 py-1 rounded-lg border border-[var(--glass-border)] bg-[var(--pill-bg)]" style="color: var(--text-main)">{{ selected.first_air_date || selected.release_date }}</span>
                     <span class="text-[10px] font-bold px-2.5 py-1 rounded-lg bg-yellow-500/10 text-yellow-600 border border-yellow-500/20">â˜… {{ selected.vote_average?.toFixed(1) }}</span>
                     
                     <span v-if="selected.air_time_iso" class="text-[10px] font-bold px-2.5 py-1 rounded-lg bg-green-500/10 text-green-500 border border-green-500/20">
                         {{ formatTime(selected.air_time_iso) }} æ›´æ–°
                     </span>
                     
                     <span v-if="selected.episode_info" class="text-[10px] font-bold px-2.5 py-1 rounded-lg bg-blue-500/10 text-blue-500 border border-blue-500/20">
                        S{{selected.episode_info.season}}E{{selected.episode_info.number}}
                     </span>
                </div>
                <p class="text-sm leading-relaxed font-medium opacity-90" style="color: var(--text-sub)">{{ selected.overview || 'æš‚æ— ç®€ä»‹' }}</p>
                <div class="mt-10 mb-6">
                    <button class="w-full py-4 rounded-2xl font-bold text-white bg-[var(--accent-blue)] active:scale-95 transition-transform shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2">
                        <i class="fas fa-play"></i> å¼€å§‹æ’­æ”¾
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const TMDB_IMG = 'https://image.tmdb.org/t/p/';
        const isLight = ref(false);
        const currentMainTab = ref('mine'); 
        const currentSubTab = ref('fav_week'); 
        const selectedDay = ref(new Date().getDay());
        const weekDays = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
        
        const loading = ref(false);
        const rawData = ref([]);
        const selected = ref(null);
        
        const touchStartX = ref(0); const touchEndX = ref(0);

        const toggleTheme = () => {
            isLight.value = !isLight.value;
            const container = document.getElementById('app-container');
            if(isLight.value) container.classList.add('light-mode');
            else container.classList.remove('light-mode');
        };

        const subTabs = computed(() => {
            if (currentMainTab.value === 'mine') {
                return [ 
                    { key: 'fav_week', name: 'è¿½ç•ªå‘¨å†' },
                    { key: 'watching', name: 'æ­£åœ¨è§‚çœ‹' },
                    { key: 'watchlist', name: 'ç¨åè§‚çœ‹' },
                    { key: 'fav_all', name: 'å…¨éƒ¨æ”¶è—' } 
                ];
            } else {
                return [ 
                    { key: 'schedule', name: 'æ–°ç•ªæ—¶åˆ»' }, 
                    { key: 'trakt_hot', name: 'Traktçƒ­é—¨' },
                    { key: 'hot', name: 'çƒ­æ˜ ä¸­' }, 
                    { key: 'top', name: 'é«˜åˆ†æ¦œ' } 
                ];
            }
        });

        const isScheduleTab = computed(() => ['schedule', 'fav_week'].includes(currentSubTab.value));

        const getFakeEpisode = (item) => {
            if(item.episode_info) return \`S\${item.episode_info.season} E\${item.episode_info.number}\`;
            if(item.media_type === 'movie') return 'å‰§åœºç‰ˆ';
            const ep = (item.id % 12) + 1;
            return \`ç¬¬ \${ep} é›†\`;
        };
        const getStatusText = (item) => {
             if(item.air_time_iso) return 'æ›´æ–°ä¸­';
             if(item.media_type === 'movie') return 'å…¨1é›†';
             return 'è¿è½½ä¸­';
        };
        const getStatusLabel = () => {
            if(currentSubTab.value === 'hot') return 'çƒ­æ˜ æ¨è';
            if(currentSubTab.value === 'trakt_hot') return 'Trakt è¶‹åŠ¿';
            return 'ä»Šæ—¥æ›´æ–°';
        };

        const fetchData = async () => {
            loading.value = true;
            rawData.value = [];
            let url = '';
            
            if(currentSubTab.value === 'fav_week') url = '/api/user/calendar'; 
            else if(currentSubTab.value === 'watching') url = '/api/user/history';
            else if(currentSubTab.value === 'watchlist') url = '/api/user/watchlist';
            else if(currentSubTab.value === 'fav_all') url = '/api/user/favs';
            else url = \`/api/list?tab=\${currentSubTab.value}\`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                rawData.value = Array.isArray(data) ? data : (data.results || []);
            } catch(e) { console.error(e); } 
            finally { loading.value = false; }
        };

        const switchMainTab = (tab) => {
            currentMainTab.value = tab;
            currentSubTab.value = tab === 'mine' ? 'fav_week' : 'schedule';
            fetchData();
        };

        watch(currentSubTab, () => fetchData());

        const filteredList = computed(() => {
            let list = rawData.value;
            if (isScheduleTab.value) {
                return list.filter(i => {
                    let dateStr = i.first_air_date || i.release_date;
                    if (i.air_time_iso) dateStr = i.air_time_iso;
                    if(!dateStr) return false;
                    return new Date(dateStr).getDay() === selectedDay.value;
                }).sort((a,b) => {
                    if (a.air_time_iso && b.air_time_iso) {
                         return new Date(a.air_time_iso) - new Date(b.air_time_iso);
                    }
                    return 0;
                });
            }
            return list;
        });

        const infiniteBannerList = computed(() => {
            const source = filteredList.value.slice(0, 5); 
            if (source.length === 0) return [];
            if (source.length === 1) return source; 
            let res = [];
            for(let i=0; i<20; i++) res = res.concat(source);
            return res;
        });

        const touchStart = (e) => touchStartX.value = e.changedTouches[0].screenX;
        const touchEnd = (e) => {
            touchEndX.value = e.changedTouches[0].screenX;
            handleSwipe();
        };

        const handleSwipe = () => {
            if (!isScheduleTab.value) return;
            const diffX = touchEndX.value - touchStartX.value;
            if (Math.abs(diffX) > 100) {
                if (diffX > 0) selectedDay.value = (selectedDay.value - 1 + 7) % 7;
                else selectedDay.value = (selectedDay.value + 1) % 7;
            }
        };

        const getPoster = (path) => path ? TMDB_IMG + 'w200' + path : 'https://via.placeholder.com/200x300/333/666';
        const getBackdrop = (path) => path ? TMDB_IMG + 'w780' + path : 'https://via.placeholder.com/780x400/333/666';
        const openDetail = (item) => selected.value = item;
        
        const formatTime = (isoStr) => {
            if(!isoStr) return '';
            const date = new Date(isoStr);
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            return \`\${h}:\${m}\`;
        };

        onMounted(() => fetchData());

        return {
            isLight, toggleTheme, currentMainTab, switchMainTab, currentSubTab, subTabs,
            selectedDay, weekDays, loading, filteredList, infiniteBannerList, selected, 
            getPoster, getBackdrop, openDetail, getFakeEpisode, getStatusText, getStatusLabel,
            touchStart, touchEnd, isScheduleTab, formatTime
        };
    }
}).mount('#app-container');
</script>
<style>
@keyframes pop { from { transform: scale(0.92) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
.animate-pop { animation: pop 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
.glass-3d {
    background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
}
.light-mode .glass-3d {
    background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.4));
}
.fade-slide-enter-active, .fade-slide-leave-active { transition: all 0.25s ease; }
.fade-slide-enter-from { opacity: 0; transform: translateX(10px); }
.fade-slide-leave-to { opacity: 0; transform: translateX(-10px); }
</style>
</body>
</html>   
`;
